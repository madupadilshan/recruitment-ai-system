name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  # 1. Backend Build Job
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/recruitment-ai-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 2. Frontend Build Job (Runs in parallel)
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/recruitment-ai-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 3. AI Service Build Job (Runs in parallel)
  build-ai-service:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and push AI Service
        uses: docker/build-push-action@v4
        with:
          context: ./ai-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/recruitment-ai-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 4. Deploy Job (Runs only after all builds are complete)
  deploy:
    needs: [build-backend, build-frontend, build-ai-service]
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # 1. Setup Swap Space (Fix for Error 137 - Out of Memory)
            if [ $(swapon --show | wc -l) -eq 0 ]; then
              echo "Creating 2GB Swap file..."
              sudo fallocate -l 2G /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              echo "Swap created successfully."
            else
              echo "Swap already exists."
            fi

            cd recruitment-ai-system
            git pull origin main

            # Create .env file with secrets
            echo "MONGO_URI=${{ secrets.MONGO_URI }}" > .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
            echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> .env

            # Pull new images
            docker-compose -f docker-compose.prod.yml pull

            # Restart containers with new images
            docker-compose -f docker-compose.prod.yml up -d

            # Clean up unused images
            docker image prune -f
